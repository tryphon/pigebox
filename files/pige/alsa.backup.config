#
# Config sample for Alsa.Backup
#
# Usage: 
#   alsa-backup --config /path/to/this/file
#

#
# To use syslog
#
require 'syslog_logger'
ALSA.logger = AlsaBackup.logger = SyslogLogger.new('alsa.backup').tap do |logger|
  logger.level = Logger::INFO
end

AlsaBackup.logger.info("load config #{__FILE__}")

AlsaBackup.config do |recorder|
  recorder.device = "default"

  card_id = IO.read("/proc/asound/card0/id").strip rescue nil
  AlsaBackup.logger.info "Card detected: #{card_id}"

  # tuner card requires an huge buffer
  case card_id
  when "SAA7134"
    recorder.buffer_time = 1000000
    recorder.period_time = recorder.buffer_time / 4
  end

  first_filename = nil
  first_file_until = nil

  recorder.file = Proc.new { |first_file|
    now = Time.now.utc
    if first_file and (first_file_until.nil? or now < first_file_until)
      unless first_filename
        first_filename = now.strftime("%Y/%m-%b/%d-%a/%Hh%Mm%S.wav")
        first_file_until = (now.floor(:min, 5) + 5 * 60)
        AlsaBackup.logger.debug("First file should end at #{first_file_until}")
      end
      first_filename
    else
      first_filename = nil
      now.floor(:min, 5).strftime("%Y/%m-%b/%d-%a/%Hh%M.wav")
    end
  }
  recorder.directory="/srv/pige/records"

  recorder.on_close do |file|
    AlsaBackup.logger.info "index record #{file}"
    system "sudo -u www-data /usr/share/pige/bin/pige index #{file} &"
  end
end


